<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analytics - God Mode</title>
    <link rel="stylesheet" href="/admin/admin_dashboard.css">
    <link rel="stylesheet" href="/admin/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Vis.js for Network Graph -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        .god-mode-container {
            padding: 20px;
        }

        .section-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .section-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }

        /* ROI Table */
        .roi-table-wrapper {
            overflow-x: auto;
        }

        .roi-table {
            width: 100%;
            border-collapse: collapse;
        }

        .roi-table th,
        .roi-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .roi-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .roi-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .roi-high {
            background-color: #d4edda;
            color: #155724;
        }

        .roi-med {
            background-color: #fff3cd;
            color: #856404;
        }

        .roi-low {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Matchmaking */
        .matchmaking-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .brand-select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            min-width: 250px;
        }

        .match-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background: #fff;
            transition: transform 0.2s;
        }

        .match-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .match-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }

        .match-info {
            flex-grow: 1;
        }

        .match-score-container {
            text-align: right;
            min-width: 80px;
        }

        .match-score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4a90e2;
        }

        /* Ecosystem Graph */
        #ecosystem-network {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fcfcfc;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>

<body>
    <!-- Navbar (Copied from dashboard) -->
    <nav class="navbar">
        <div class="navbar-left">
            <button class="menu-btn" onclick="toggleLeftNavbar()">☰</button>
            <div class="sidebar" id="sidebar">
                <button class="close-btn" onclick="toggleLeftNavbar()">×</button>
                <div class="menu">
                    <ul class="list">
                        <li>
                            <a href="/admin/dashboard">
                                <i class="fas fa-chart-line"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li class="active">
                            <a href="/admin/analytics">
                                <i class="fas fa-brain"></i>
                                <span>God Mode Analytics</span>
                            </a>
                        </li>
                        <li>
                            <a href="/admin/user_management">
                                <i class="fas fa-users"></i>
                                <span>User Management</span>
                            </a>
                        </li>
                        <li>
                            <a href="/admin/collaboration_monitoring">
                                <i class="fas fa-handshake"></i>
                                <span>Collaborations</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="heading">
            <h1>CollabSync Admin</h1>
        </div>
        <div class="navbar-right">
            <div class="profile">
                <!-- Simple Profile placeholder -->
                <div class="profile-icon">
                    <span>Admin</span>
                </div>
            </div>
        </div>
    </nav>

    <h1>Advanced Analytics (God Mode)</h1>

    <div class="main-content god-mode-container">

        <!-- Feature 1: Influencer ROI Leaderboard -->
        <div class="section-card">
            <div class="section-header">
                <h2>Influencer Real Value (ROI) Leaderboard</h2>
                <button onclick="loadROI()" class="btn btn-sm btn-outline-primary"><i class="fas fa-sync"></i>
                    Refresh</button>
            </div>
            <p>Calculated based on confirmed sales revenue generated vs. commissions paid.</p>
            <div id="roi-container" class="roi-table-wrapper">
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading ROI Data...</div>
            </div>
        </div>

        <!-- Feature 2: Brand-Influencer Matchmaking -->
        <div class="section-card">
            <div class="section-header">
                <h2>AI Matchmaking Engine</h2>
            </div>
            <div class="matchmaking-controls">
                <select id="brand-select" class="brand-select" onchange="runMatchmaking()">
                    <option value="">Select a Brand to find matches...</option>
                    <% if(brands && brands.length> 0) { %>
                        <% brands.forEach(brand=> { %>
                            <option value="<%= brand._id %>">
                                <%= brand.brandName %>
                            </option>
                            <% }); %>
                                <% } %>
                </select>
                <div id="match-status"></div>
            </div>
            <div id="match-results">
                <!-- Results will appear here -->
            </div>
        </div>

        <!-- Feature 3: Ecosystem Graph -->
        <div class="section-card">
            <div class="section-header">
                <h2>The Ecosystem (Network Graph)</h2>
                <div>
                    <span style="color:#2B7CE9; margin-right:10px;"><i class="fas fa-circle"></i> Brands</span>
                    <span style="color:#97C2FC;"><i class="fas fa-circle"></i> Influencers</span>
                </div>
            </div>
            <p>Visualizing connections between Brands (Blue) and Influencers (Light Blue). Line thickness represents
                collaboration value.</p>
            <div id="ecosystem-network"></div>
        </div>

    </div>

    <script>
        // --- 1. ROI Logic ---
        async function loadROI() {
            const container = document.getElementById('roi-container');
            container.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            try {
                const res = await fetch('/admin/analytics/influencer-roi');
                const data = await res.json();

                if (data.success && data.data.length > 0) {
                    let html = `
                        <table class="roi-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Influencer</th>
                                    <th>Orders</th>
                                    <th>Revenue Generated</th>
                                    <th>Commission Paid</th>
                                    <th>ROI Score</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.data.forEach((item, index) => {
                        const roiVal = item.roiScore === 'Infinity' ? '∞' : item.roiScore.toFixed(2) + 'x';
                        let badgeClass = 'roi-low';
                        if (item.roiScore > 10) badgeClass = 'roi-high';
                        else if (item.roiScore > 5) badgeClass = 'roi-med';

                        html += `
                            <tr>
                                <td>#${index + 1}</td>
                                <td>
                                    <strong>${item.name}</strong><br>
                                    <small class="text-muted">@${item.username}</small>
                                </td>
                                <td>${item.orderCount}</td>
                                <td>$${item.totalRevenue.toLocaleString()}</td>
                                <td>$${item.totalCommission.toLocaleString()}</td>
                                <td><span class="roi-badge ${badgeClass}">${roiVal}</span></td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p class="text-center p-3">No sales data available yet to calculate ROI.</p>';
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p class="text-danger">Error loading ROI data.</p>';
            }
        }

        // --- 2. Matchmaking Logic ---
        async function runMatchmaking() {
            const brandId = document.getElementById('brand-select').value;
            const container = document.getElementById('match-results');

            if (!brandId) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Finding best matches...</div>';

            try {
                const res = await fetch(`/admin/matchmaking/brand/${brandId}`);
                const data = await res.json();

                if (data.success && data.data.length > 0) {
                    let html = '<div class="matches-grid">';
                    data.data.forEach(match => {
                        const inf = match.influencer;
                        html += `
                            <div class="match-card">
                                <img src="${inf.profilePicUrl || '/images/default-avatar.png'}" class="match-avatar">
                                <div class="match-info">
                                    <h4>${inf.fullName || inf.username}</h4>
                                    <p class="mb-1"><small>${inf.niche || 'General'}</small> • <small>${(inf.totalFollowers || 0).toLocaleString()} followers</small></p>
                                    <div>
                                        ${match.matchReasons.map(r => `<span class="badge bg-light text-dark border me-1">${r}</span>`).join('')}
                                    </div>
                                </div>
                                <div class="match-score-container">
                                    <div class="match-score">${match.matchScore}%</div>
                                    <small>Match</small>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p>No matches found.</p>';
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p class="text-danger">Error running matchmaking.</p>';
            }
        }

        // --- 3. Ecosystem Graph Logic ---
        async function loadGraph() {
            const container = document.getElementById('ecosystem-network');
            try {
                const res = await fetch('/admin/analytics/ecosystem');
                const data = await res.json();

                if (data.success) {
                    const nodes = new vis.DataSet(data.data.nodes);
                    const edges = new vis.DataSet(data.data.links.map(l => ({
                        from: l.source,
                        to: l.target,
                        width: Math.max(1, l.value / 100), // Scale thickness
                        color: { inherit: 'from' }
                    })));

                    const dataSet = { nodes, edges };
                    const options = {
                        nodes: {
                            shape: 'dot',
                            size: 20,
                            font: { size: 14 }
                        },
                        physics: {
                            stabilization: false,
                            barnesHut: {
                                gravitationalConstant: -8000,
                                springConstant: 0.04,
                                springLength: 95
                            }
                        },
                        interaction: {
                            tooltipDelay: 200,
                            zoomView: true
                        }
                    };

                    new vis.Network(container, dataSet, options);
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p class="text-danger text-center pt-5">Error loading graph data.</p>';
            }
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadROI();
            loadGraph();

            // Toggle sidebar logic (simplified from dashboard)
            window.toggleLeftNavbar = function () {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) sidebar.classList.toggle('active');
            }
        });

    </script>
</body>

</html>