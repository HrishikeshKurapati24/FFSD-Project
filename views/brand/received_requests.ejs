<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Received Requests - CollabSync</title>
  <link rel="stylesheet" href="/B2_index/B2_recievedRequests.css">
  <link rel="stylesheet" href="/B2_index/received_requests.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <!-- Header -->
  <header>
    <div class="header-container">
      <div class="logo">CollabSync</div>
      <nav>
        <ul>
          <li><a href="/brand/home">Home</a></li>
          <li><a href="/brand/explore">Explore Influencers</a></li>
          <li><a href="/brand/profile">My Brand Profile</a></li>
          <!-- <li><a href="logout">Logout</a></li> -->
        </ul>
      </nav>
    </div>
  </header>

  <!-- Sidebar Navigation (Right Side) -->
  <button class="toggle-btn" onclick="openMenu()">â˜°</button>
  <div class="menu" id="navMenu">
    <span class="close-btn" onclick="closeMenu()">&times;</span>
    <!-- <a href="/I_explore">Brands</a> //////////////////////////////////////////////////////////////////////////////////////////////////////-->
    <a href="/brand/recievedRequests">Collab requests</a>
    <a href="/brand/create_collab">Create Collab</a>
    <a href="/brand/signout">Sign Out</a>
    <!-- <a href="#">Settings</a> -->
  </div>

  <!-- Main Content -->
  <div class="container">
    <input type="text" class="search-bar" placeholder="Search for collabs..." onkeyup="searchCollabs(this.value)">
    <div class="collab-list">
      <!-- Dynamically render requests -->
      <% if(requests && requests.length> 0){ requests.forEach(request=> { %>
        <div class="collab-box"
          data-title="<%= ((request.collab && request.collab.title) ? request.collab.title : '').toLowerCase() %>">
          <div class="collab-header">
            <h2 class="collab-title">
              <%= (request.collab && request.collab.title) %>
            </h2>
            <span class="tag-badge">
              <%= request.tag %>
            </span>
            <p class="collab-description">
              <%= (request.collab && request.collab.description) %>
            </p>
          </div>
          <div class="bottom-row">
            <!-- Left Column: Influencer Details -->
            <div class="left-col">
              <div class="blue-box">
                <h3><i class="fas fa-user-circle"></i> Influencer Details</h3>
                <div class="influencer-profile">
                  <img
                    src="<%= (request.influencer && request.influencer.profile_pic) ? request.influencer.profile_pic : '/images/default-avatar.jpg' %>"
                    alt="<%= (request.influencer && request.influencer.name) %>" class="influencer-avatar">
                  <div class="influencer-info">
                    <h4>
                      <%= (request.influencer && request.influencer.name) %>
                    </h4>
                    <p class="influencer-username">@<%= (request.influencer && request.influencer.username) || '' %>
                    </p>
                  </div>
                </div>
                <div class="influencer-stats">
                  <div class="stat-item">
                    <i class="fas fa-users"></i>
                    <span class="attr">Total Followers:</span>
                    <span class="value">
                      <%= ((request.influencer && request.influencer.followers) ? request.influencer.followers :
                        0).toLocaleString() %>
                    </span>
                  </div>
                  <div class="stat-item">
                    <i class="fas fa-chart-line"></i>
                    <span class="attr">Engagement Rate:</span>
                    <span class="value">
                      <%= (request.influencer && request.influencer.engagement_rate) %>%
                    </span>
                  </div>
                  <div class="stat-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span class="attr">Location:</span>
                    <span class="value">
                      <%= (request.influencer && request.influencer.location) || 'Not specified' %>
                    </span>
                  </div>
                  <div class="stat-item">
                    <i class="fas fa-tags"></i>
                    <span class="attr">Categories:</span>
                    <span class="value">
                      <%= ((request.influencer && request.influencer.categories) ?
                        request.influencer.categories.join(', ') : ' Not specified') %>
                    </span>
                  </div>
                </div>
                <div class="social-channels">
                  <h4><i class="fas fa-share-alt"></i> Social Channels</h4>
                  <div class="channels-grid">
                    <% if (request.influencer && request.influencer.channels && request.influencer.channels.length> 0) {
                      %>
                      <% request.influencer.channels.forEach(channel=> { %>
                        <div class="channel-item">
                          <i class="fab fa-<%= channel.toLowerCase() %>"></i>
                          <span>
                            <%= channel %>
                          </span>
                        </div>
                        <% }); %>
                          <% } else { %>
                            <p class="no-channels">No channels specified</p>
                            <% } %>
                  </div>
                </div>
              </div>
            </div>
            <!-- Right Column: Collab Requirements -->
            <div class="red-col">
              <div class="collab-requirements">
                <h3><i class="fas fa-clipboard-list"></i> Campaign Requirements</h3>
                <div class="requirements-grid">
                  <div class="requirement-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="attr">Duration:</span>
                    <span class="value">
                      <%= (request.collab && request.collab.duration) %> days
                    </span>
                  </div>
                  <div class="requirement-item">
                    <i class="fas fa-dollar-sign"></i>
                    <span class="attr">Budget:</span>
                    <span class="value">$<%= ((request.collab && request.collab.budget) ? request.collab.budget :
                        0).toLocaleString() %></span>
                  </div>
                  <div class="requirement-item">
                    <i class="fas fa-users"></i>
                    <span class="attr">Min Followers:</span>
                    <span class="value">
                      <%= ((request.collab && request.collab.min_followers) ? request.collab.min_followers :
                        0).toLocaleString() %>
                    </span>
                  </div>
                  <div class="requirement-item">
                    <i class="fas fa-bullseye"></i>
                    <span class="attr">Target Audience:</span>
                    <span class="value">
                      <%= (request.collab && request.collab.target_audience) %>
                    </span>
                  </div>
                </div>
                <div class="channels-section">
                  <h4><i class="fas fa-share-alt"></i> Required Channels</h4>
                  <div class="channels-list">
                    <% if (request.collab && request.collab.required_channels &&
                      request.collab.required_channels.length> 0) { %>
                      <% request.collab.required_channels.forEach(channel=> { %>
                        <span class="channel-badge">
                          <%= channel %>
                        </span>
                        <% }); %>
                          <% } else { %>
                            <p class="no-channels">No channels required</p>
                            <% } %>
                              <% if (request && request.message) { %>
                                <div class="influencer-message-bar">
                                  <strong>Message from influencer:</strong>
                                  <div class="message-text">
                                    <%= request.message %>
                                  </div>
                                </div>
                                <% } %>
                  </div>
                </div>

                <!-- Campaign Products Section -->
                <% if (request.collab && request.collab.products && request.collab.products.length> 0) { %>
                  <div class="products-section">
                    <h4><i class="fas fa-shopping-bag"></i> Campaign Products</h4>
                    <div class="products-grid">
                      <% request.collab.products.forEach(product=> { %>
                        <div class="product-item">
                          <div class="product-image">
                            <% if (product.image_url) { %>
                              <img src="<%= product.image_url %>" alt="<%= product.name %>" class="product-img">
                              <% } else { %>
                                <div class="product-placeholder">
                                  <i class="fas fa-image"></i>
                                </div>
                                <% } %>
                          </div>
                          <div class="product-details">
                            <h5 class="product-name">
                              <%= product.name %>
                            </h5>
                            <div class="product-pricing">
                              <span class="campaign-price">$<%= product.campaign_price.toLocaleString() %></span>
                            </div>
                          </div>
                        </div>
                        <% }); %>
                    </div>
                  </div>
                  <% } %>

                    <div class="action-buttons">
                      <a href="/brand/<%= request._cid %>/<%= request._iid %>/transaction" class="accept-btn">
                        <i class="fas fa-check"></i> Accept and Proceed
                      </a>
                      <button class="decline-btn" onclick="declineRequest('<%= request._cid %>','<%= request._iid %>')">
                        <i class="fas fa-times"></i> Decline
                      </button>
                    </div>
              </div>
            </div>
          </div>
        </div>
        <% }); } else { %>
          <div class="no-requests-message">
            <div class="no-requests-icon">
              <i class="fas fa-inbox"></i>
            </div>
            <h3>No Requests Yet</h3>
            <p>You haven't received any collaboration requests at the moment.</p>
            <p>Create campaigns and invite influencers to start receiving requests!</p>
            <a href="/brand/create_collab" class="create-campaign-btn">
              <i class="fas fa-plus"></i> Create New Campaign
            </a>
          </div>
          <% } %>
    </div>
  </div>

  <!-- Sidebar Toggle Script -->
  <script>
    function openMenu() {
      document.getElementById("navMenu").style.width = "250px";
    }
    function closeMenu() {
      document.getElementById("navMenu").style.width = "0";
    }

    function searchCollabs(query) {
      query = query.toLowerCase();
      const collabBoxes = document.querySelectorAll('.collab-box');

      collabBoxes.forEach(box => {
        const title = box.getAttribute('data-title');
        if (title.startsWith(query)) {
          box.style.display = 'block';
        } else {
          box.style.display = 'none';
        }
      });
    }

    async function declineRequest(requestId1, requestId2) {
      if (confirm('Are you sure you want to decline this request?')) {
        try {
          const response = await fetch(`/brand/requests/${requestId1}/${requestId2}/decline`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            // Show success message
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.textContent = data.message;
            document.body.appendChild(successMessage);

            // Remove message after 3 seconds
            setTimeout(() => {
              successMessage.remove();
              location.reload();
            }, 3000);
          } else {
            throw new Error(data.message || 'Failed to decline request');
          }
        } catch (error) {
          console.error('Error declining request:', error);
          alert(error.message || 'An error occurred while declining the request');
        }
      }
    }

  </script>
</body>

</html>